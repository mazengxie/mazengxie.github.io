---
title: OpenStack vs Kubernetes，谁更适合自己？
key: 20180907
tags: cloud
---

## 1. 云计算开源框架
全球云计算的龙头亚马逊近日风光无限，成为继苹果公司之后，第二个市值突破万亿美元公司。但是市盈率却高达400倍，而同期苹果公司却只有20倍。暂且不说亚马逊能否撑起如此之高的市盈率，可见全球市场对云计算未来乐观的发展预期。云计算的概念在2006年由谷歌首次提出，大约经过10年的探索和技术积累，在2015年开始进入应用的繁荣期。
<!--more-->

亚马逊占据了市场60%的市场份额，具有绝对领先的地位。亚马逊的CEO贝佐斯要求开发人员按照SOA理念来进行开发，即面向服务的理念，要求所有程序模块必须要用服务接口把数据和功能开放出来，这种设计理念也奠定了现在AWS的基本技术基础。

### 1.1 OpenStack的诞生和繁荣
当然参与云计算的公司一直都很多，在2010年7月，RackSpace和NASA(美国国家航空航天局)，分别捐献出RackSpace云文件平台代码和NASANebula平台代码，OpenStack由此诞生。OpenStack作为AWS的追随者，其设计理念和AWS都非常的相似，核心组件包括计算（Nova）、对象存储（Swift）、认证（Keystone）、用户界面（Dashboard）、块存储（Cinder）、网络（Neutron）和镜像服务（Glance），这些组件协同工作为用户提供计算、网络和存储等硬件资源。

OpenStack这种DIY的设计模式受了极大追捧，而且OpenStack涉及的概念和调用接口也和AWS一致。用户可以把AWS上的应用无缝迁移到基于OpenStack的云平台上，思科、IBM、HP等一些列的IT巨头纷纷基于OpenStack推出了自己的公有云平台。OpenStack不光在公有云上作为AWS的替代者，而且在私有云领域也打破了VMware公司在服务器虚拟机的垄断。全世界的云计算工程师都为之欢呼，因此基于OpenStack的产业链也就诞生了。

国内出现了很多基于OpenStack的创业公司，比如united stack、easystack、awcloud等。拥有最多数据中心的三大运营商，也分别成立云计算分公司并组建OpenStack团队。还有一些金融等传统行业也成立自己的事业部，志在基于OpenStack打造自己的私有云。互联网巨头腾讯和百度，也有自己的OpenStack团队和对应的产品。所以在OpenStack黄金会员里面，我们华人公司占据了一半的席位。

随着OpenStack的蓬勃发展，其笨重、性能等缺陷日益显露。部署起来非常复杂，光部署工具就有很多种；使用起来性能也不是太好，非常多的重复代码。而且社区管理也有问题，功能组件繁多且重复，围绕OpenStack有100多个项目，各个厂商利益角逐。就比如裸机管理项目最开始是ironic，后面华为和intel又搞出来mogon。两个项目只是代码框架不同却是实现相同的功能，裸机管理的有多个项目情况并不是特例，这无疑分散了OpenStack的研发实力。

有些PTL和TC更是想把自己的项目脱离OpenStack单独部署，无非是想脱离走下坡路的OpenStack社区。目前社区的一些任务目标，PTL响应也不够，完成度更不用说了。因为随着OpenStack的衰落，公司支持力度下降，有些PTL都是兼职自愿奉献社区。就比如Trove项目的前任PTL，因为Tesora被收购一拍屁股走人，我们国人接过来trove的PTL重担，但是2018年温哥华峰会的时候，据说因为其个人原因没有如期参加吧，也饱受批评。

OpenStack经历了短暂的繁荣期，2015年惠普把EG（中国惠普企业集团）51%的股份卖给了紫光股份，并于次年2017年9月彻底解散了国内云计算团队；惠普美国云计算也纷纷有大佬离职，并把OpenStack组件资产卖给了SUSE，表示SUSE将是其OpenStack业务发展的首选合作伙伴。思科也在2017年3月关闭基于OpenStack的Intercloud公有云服务，并宣称将专注于混合云和网络虚拟化服务的提供。IBM也在2018年放弃OpenStack，转向做kubernetes去了。

但是国内在云计算领域公有云份额很少，私有云份额很大占到95%，所以仍然有很多厂商在私有云领域采用OpenStack，至于公有云的话，OpenStack框架确实也不太适合。国内华为、金山等公有云厂商，虽然使用的OpenStack，但是基本上功能已经改了很多了。

### 1.2 Kubernetes的开场
伴随着OpenStack的衰落，Kubernetes已经成为新贵。说到Kubernetes，不得不说一下docker。

2013年3月dotcloud公司推出了一项新的容器技术Docker。说到容器技术，也不是什么新技术，只是非常的小众。然而Docker的出现，降低了容器技术使用的门槛，带来了无可比拟的优势，所以迅速在IT行业内普及。不光是IT工程师，还是产品经理等非技术工作人员，人们争相讨论着容器化会带来哪些便利和优势，也像OpenStack一样催化了无数的创业公司。

但是在Docker发布的初期，受到了谷歌、IBM等互联网巨头的挤压，同期也有CoreOS推出的rkt等容器技术作为有力的竞争者。互联网巨头纷纷站队，或者推出自己的容器技术。互联网巨头有着众多的研究人员、雄厚的经济实力和丰富的项目经验，初创公司对此毫无招架之力。

于是Docker的创始人决定把Docker开源，让全世界的感兴趣的容器工作者参与其中，无疑增加了研发实力。然后建立了全世界最丰富的镜像仓库，使用者可以在这里找到自己想要的镜像，间接也增加了docker的用户群。最后就是通过融资，收购了一些容器编排相关的创业公司来提升自己的整体实力。

这样的竞争持续了两年多，最终在DockerCon 2015上，Docker的创始人和CoreOS的创始人最终握手言和，并成立runC项目，和基金会一起维护容器的标准。此时Docker已然给云计算、应用交付等多个领域带来巨大的革新。


随着Docker的普及和使用，其自身的性能无法满足大规模集群的使用，需要一个工具对成千上万个容器进行统一编排。在2015年又开始了容器编排之争，行业内最主要的三个编排框架分别是docker公司的swarm、google的kubernetes以及Apache  mesos。Mesos是参考谷歌的borg集群管理技术，并于2009年推出的。swarm和kubernetes是为docker等容器技术，新推出的框架。swarm是docker公司发布的，有近水楼台先得月的优势。kubernetes是参考谷歌的borg系统10几年的容器管理经验，重新推出的一套容器管理框架，可谓含着金钥匙出身，kubernetes迅速得到了微软，红帽等支持。这场战争不用打，或许都已经猜到结局是什么，战争的胜利只是一个时间问题。

Docker公司的用户大部分是IT开发人员，所以靠这些用户带来盈利是非常难的。Docker公司在2017年1月把docker分为社区版docker-ce和商业版docker-ee，一直没有放弃盈利的机会，但是也一直没有找到盈利的方式。终于，2017年10月的dockerCon峰会上，docker公司官方支持Kubernetes，确立了kubernetes成为了容器编排界事实上的标准。

2018年初docker的母公司cloud control还一度传出资不抵债要破产的节奏。有人说docker和kubernetes的出现加速了OpenStack的衰落，确实容器技术会抢占一部分虚拟机的市场。但是OpenStack的衰落自身也有原因，包括OpenStack也有些容器相关的项目，但是在我看来顶多算个自我救赎而已，始终不能摆脱那个复杂的框架。

## 2. IoT下IaaS架构的选择
国内阿里涉足云计算领域比较早，所以阿里云采用的是自身研发的云计算架构，其余公司都或多或少的采用开源的云计算架构。所以在4月26日云栖大会·南京峰会上，阿里云副总裁李津表示：“中国只有两种云，一种是拿来主义的云，一种是自主可控的飞天云”。当然这不完全准确，但也能反映目前国内公有云和私有云市场现状。

日前，美国权威调研机构Gartner发布了全球公共云市场份额报告(2017年)。从报告中可以发现，全球公有云前三市场份额占到66%，且持续扩大。另外Gartner的“2018年全球公共云魔力象限”也有所体现，2017年有14家企业入围魔力象限，而2018年只有6家，这也意味着全球云计算市场头部企业和尾部企业差距逐渐拉大。与国际市场不同的是，我们国内IaaS市场是阿里云一家独大，但是PaaS层和SaaS层才刚刚发展，所以不失为一个突破口。

先看一下，谷歌云的IoT的框架图
![](/images/2018-09-07/google-iot.jpg)

把物联网设备通过某种协议，接入到IoT云平台。IoT云平台对外提供API接口，我们可以通过接口控制物联网设备。谷歌在物联网和AI这一块做的比较成熟，还开发了对应的物联网芯片cloud edge，可以直接植入到散布在全球各地的物联网设备。在云平台一侧，开发大数据分析的模块big query，更加方便第三方厂商对物联网设备的数据进行分析，打造从芯到云的整个产业链。

我们目前还处于的初级阶段，第一阶段首先实现物联网设备接入到自研IoT云平台，然后APP调用IoT云平台对外的API接口，控制和收集设备的状态。使用户利用从分布在全球的设备获得的数据，实时发掘业务数据洞见。IoT平台收集的设备数据将发布到订阅和发布系统以进行下游分析。目前支持简单的大数据分析，丰富的报表和信息中心以可视化的方式呈现物联网数据结果。 

IaaS层要为IoT PaaS平台提供动态可扩展的网络、计算和存储等资源。初期网络的流量主要是设备到IoT后台服务、app和Iot后台服务之间的交互，所以网络模型相对简单。网络的峰值一般会出现在一天中的晚上某个时刻，这个时候后台服务的压力就比较大，相应的要求更多计算资源。对于存储的话，前期阶段主要是物联网设备的数据和用户的数据，存储量比较少。

综合上面的因素，高峰期时对计算的要求比较大，然而网络和存储的要求比较简单。所以选择轻量级的docker+kubernetes能实现高峰期的自动扩容，而且也支持网络自动化和存储持久化。Kubernetes的社区发展情况来看，更加倾向于服务的治理，即PaaS层的编排工具，但是又有非常丰富的插件，可以直接运行在真实的服务器、虚拟机、国内外公有云上。如果公司有丰富的原始技术积累，还是采用定制化自研云平台，平台升级就不会涉及到与社区版本的兼容性。但是国内的大部分公司由于研发实力不够一般都采用成熟的开源社区项目，随着上线产品的优化，迭代完善使用的开源框架。

## 3. PaaS和IaaS的共同演进
目前谷歌云IoT业务植入大数据和AI的元素，能够根据用户的物联网设备数据分析出每个用户的习惯等，也提供一些AI的方案供用户选择。随着PaaS层陆续增加大数据和AI等功能，对IaaS的要求也就越来越高。Kubernetes在生产环境上的应用主要是容器编排，在8月份刚刚发布Istio(服务治理)生产环境的版本，还没有涉及像IOT等如此细分的生产项目。虽然Kubernetes社区也有AI的孵化项目，但是能不能满足我们的需要，还是要通过实践来验证。

Kubernetes提供了非常丰富的网络插件，说到网络一直是云计算领域的痛点和难点。OpenStack也有非常多的网络插件，这些插件也给使用者带来困扰。我到底选择哪个插件，那这个插件在未来会一直持续活跃下去么，还是说在不久的将来会被社区废弃。我们现在服务间的网络模型也非常简单，所以选用的flannel网络插件，所有的容器都在一个大二层里面。流量限速、网络隔离和安全问题等问题社区还在完善，随着我们业务的增长，我们也可以引入SDN等复杂的网络模型。

计算的方面的话，由于一个个容器不像虚拟机做到真正的隔离，目前是限制容器对cpu和内存的使用率来控制。如果是公有云的话，可能这样会带来潜在的风险，因为我们没有办法确定用户的镜像会不会利用系统的漏洞危害其他容器，或者独占宿主机导致超负载以至于其他容器不能获取到资源。但是我们目前是私有云的形式，我们每个服务、每个镜像都是安全可追溯的。如果后面有对虚拟机和裸机的要求，我们也可以自己开发对应的插件，或者采用OpenStack+Kubernetes的形式，来管理更复杂的集群。


我们的PaaS服务用到了Mysql、redis、mogonDB等数据库，还有emq消息队列，这些都是需要持久化存储的。如果服务器发生异常关机，那么要确保服务器启动以后，数据是可以恢复的。Kubernetes提供了ceph、公有云存储等第三方扩展，同样复杂的存储后端也跟选择上增加了负担。如果采用公有云提供的稳定的方案得话，可能带来安全和稳定性方面的顾虑。如果采用私有自建云的话，可能需要一定的技术积累。

总之，根据业务进行迭代开发，要优于一开始就做大而全的私有云方案。